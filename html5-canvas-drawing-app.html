<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>Canvas聊天板</title>
    <style type="text/css">
        body, p {
            margin: 0;
            padding: 0;
            color: saddlebrown
        }

    </style>

</head>
<body>

<div id="content">
    <canvas id="the_stage" width="1200" height="600" style="cursor: crosshair; display: block;margin: 0 auto;border: 1px solid #999;">
    </canvas>
</div>
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.1.0.min.js"></script>
<!--<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>-->
<script type="text/javascript">
    Array.prototype.add = function (item) {
        this.push(item);
        if (this.callback) this.callback.call(this, item);
    }

    //    然后你写数组,添加成员时不用push，使用add

    var Drawarr = new Array();
    var lastobj = [];
    var lastzuobiao = {};
    var canvas = document.getElementById('the_stage');
    var context = canvas.getContext('2d');
    var hasmy = false;
    var webSocket = new WebSocket('ws://192.168.4.110:1337');

    webSocket.onerror = function (event) {
        onError(event);
    };

    webSocket.onopen = function (event) {
        onOpen(event)
    };

    webSocket.onmessage = function (event) {
        onMessage(event)
    };

    function onMessage(event) {

//    console.log(JSON.parse(event.data));
//  '&quot;'
        var str = JSON.parse(event.data)
//    console.log(str.data.length);
        if (!str.data.length) {
            var newstr = str.data.text.replace(/&quot;/g, '\"');
//            console.log(JSON.parse(newstr));
            var obj=JSON.parse(newstr)
            Drawarr.add(obj)

        }

    }

    function onOpen(event) {

        console.log(event);
    }

    function onError(event) {

    }

    function start(e, stage_info, type) {
        var data = {name: 'my',color: 'red', type: type, clientX: e.clientX - stage_info.left, clientY: e.clientY - stage_info.top};

        webSocket.send(JSON.stringify(data));
        return false;
    }
    Drawarr.callback = function (item) {
        var hasname=false
        if (item.type !== 'moveup') {
            for(var i= 0;i<lastobj.length;i++){
                if (!hasname) {
                    if (lastobj[i].name == item.name) {
                        hasname=true
                    }
                }

            }

            if (!hasname) {
                lastobj.push({name:item.name,clientX:item.clientX,clientY:item.clientY})
            }else {
                for(var k= 0;k<lastobj.length;k++){
                    if (lastobj[k].name == item.name) {
                        context.moveTo(lastobj[k].clientX, lastobj[k].clientY);
                        context.lineTo(item.clientX, item.clientY);
                        context.strokeStyle = item.color;
                        context.stroke();
                        lastobj[k].clientX = item.clientX
                        lastobj[k].clientY = item.clientY
                    }

                }

            }

        }else {
            for(var j= 0;j<lastobj.length;j++){
                if (lastobj[j].name == item.name) {
                    lastobj.splice(j,1)
                }
            }
            console.log(lastobj);
        }

    }

    function Draw(arg) {
        if (arg.nodeType) {    //判断结点类型
            canvas = arg;
        } else if (typeof arg == 'string') {
//      canvas = document.getElementById(arg);
        } else {
            return;
        }
        this.init();

    }
    //  var Drawarr=[];
    Draw.prototype = {
        init: function () {
            var that = this;
            if (!canvas.getContext) {   //判断是否支持Canvas
                return;
            }
//      context = canvas.getContext('2d');
            canvas.onselectstart = function () {  //去掉选择
                return false;
            };
            canvas.onmousedown = function (event) {

                that.drawBegin(event);
            };
        },
        drawBegin: function (e) {
            var that = this,
                    stage_info = canvas.getBoundingClientRect();   //getBoundingClientRect()可以不用考虑兼容性
            window.getSelection() ? window.getSelection().removeAllRanges() : document.selection.empty(); //清除文本的选中

            start(e, stage_info, 'moveTo');
//        Drawarr.add({name:'my',color:'red',type:'moveTo',clientX:e.clientX - stage_info.left,clientY:e.clientY - stage_info.top})
//      context.moveTo(
//              e.clientX - stage_info.left,
//              e.clientY - stage_info.top
//      );
            document.onmousemove = function (event) {
                that.drawing(event);
            };

            document.onmouseup = function (e) {

                start(e, stage_info, 'moveup')
                that.drawEnd()
            };
        },
        drawing: function (e) {
            var stage_info = canvas.getBoundingClientRect();

            start(e, stage_info, 'lineTo')
//        Drawarr.add({name:'my',color:'red',type:'lineTo',clientX:e.clientX - stage_info.left,clientY:e.clientY - stage_info.top})
//      context.lineTo(
//              e.clientX - stage_info.left,
//              e.clientY - stage_info.top
//      );
//      context.strokeStyle="saddlebrown"
//      context.stroke();   //相当与fill()，填充
        },
        drawEnd: function () {
            document.onmousemove = document.onmouseup = null;       //释放内存
        }

    };

    var draw = new Draw('the_stage');


</script>
</body>
</html>