<!DOCTYPE html>
<html lang="UTF8">
<head>
    <title>ChatGo</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
        }

        canvas {
            display: block;
            background-color: #fff;
        }

    </style>
</head>
<body>

<script src="../static/js/jquery-2.1.3.min.js"></script>
<script src="../static/js/pixi.js"></script>
<script>
    // var colorArray = new Array(8)

    // for(var i=0;i<8;i++){
    //     colorArray[i]=(parseInt(Math.random()*0xFFFFFF).toString(16));
    // }
    var colorArray=[0x337d22,0xa93c67,0x941a1a,0x5e326b,0x7043b3,0x43b34e,0x438db3,0x434ab3]
    console.log(colorArray)

    Array.prototype.add = function (item) {
        this.push(item);
        if (this.callback) this.callback.call(this, item);
    }
//    alert(window.location.pathname)
    var Drawarr = new Array();
    var lastobj = [];
    var webSocket = new WebSocket('ws://'+window.location.host + "/ws" + window.location.pathname);
//    var webSocket = new WebSocket('ws://172.18.3.122:1337');
    webSocket.binaryType = 'arraybuffer';

    webSocket.onerror = function (event) {
        onError(event);
    };

    webSocket.onopen = function (event) {
        onOpen(event)
    };

    webSocket.onmessage = function (event) {
        onMessage(event)
    };

    function person(index, x, y, mosueDown){
         this.seatIndex= index;
         this.mouseDown = mosueDown;
         this.mouseX=x;
         this.mouseY=y;
    }
    var MaxRoomCapacity = 8
    var persons = new Array(MaxRoomCapacity)

    function updatePersonStatus(userId, x, y, mouseDown) {
        if (userId < 0 || userId >= MaxRoomCapacity) {
            return
        }
        var user = persons[userId]
        if (user == null) {
            user = new person(userId, x, y, mouseDown)
            persons[userId] = user
            return null
        }

        var oldStatus = new person(user.seatIndex, user.mouseX, user.mouseY, user.mouseDown)
    
        user.mouseX = x
        user.mouseY = y
        user.mouseDown = mouseDown

        return oldStatus
    }

    // ...
	var Command_MousePosition = 0

	var Command_UserInfo = 254
	var Command_ServerVersion = 255
    /*
    var command
    var command = -1
    var commandDone = false
    var index = 0

    var reset = function() {
        command = -1
        commandDone = false
        index = 0
    }
    */

    function onMessage(event) {
        //onsole.log(event);

        var bytearray = new Uint8Array(event.data);
        //console.log(bytearray.length)
        // console.log(bytearray)

        switch (bytearray[0]) {
        case Command_MousePosition:

            var x = canvasw * ((bytearray[1] << 8) | (bytearray[2] << 0)) / 0xFFFF
            var y = canvash * ((bytearray[3] << 8) | (bytearray[4] << 0)) / 0xFFFF
            var mouseDown = bytearray[5] != 0
            var userId = bytearray[6]
            
            // console.log("x=", x, ",y=", y, ",mouseDown=", mouseDown, ",userId=", userId)

            var personLastStatus = updatePersonStatus(userId, x, y, mouseDown)

            // console.log("personLastStatus=", personLastStatus)

            if (personLastStatus != null && personLastStatus.mouseDown && mouseDown) {

                context.moveTo(personLastStatus.mouseX, personLastStatus.mouseY);
                context.lineStyle(5, parseInt(colorArray[userId]), 1);
                context.lineTo(x, y);
                renderer.render(stage);
            }

            break;
        default:
            break;
        }
    }

    function onOpen(event) {
        console.log(event);
    }

    function onError(event) {

    }

    function start(e, type) {
//        var data = {name: 'my',color: 'red', type: type, clientX: e.clientX - stage_info.left, clientY: e.clientY - stage_info.top};
        

        if (type == 'moveup') {
        } else if (e.clientX > canvasw 
            || e.clientX < 0
            || e.clientY > canvash
            || e.clientY < 0){
            type ='moveup'
        }

        var mouseDown = 1
        if (type == 'moveup') {
            mouseDown = 0
        }

        var percentX = 0xFFFF * e.clientX / canvasw
        var x1 = (percentX >> 8) & 0xFF
        var x0 = (percentX >> 0) & 0xFF
        var percentY = 0xFFFF * e.clientY / canvash
        var y1 = (percentY >> 8) & 0xFF
        var y0 = (percentY >> 0) & 0xFF
        var arr = [0, x1, x0, y1, y0, mouseDown]

//        console.log(arr);
        var batesArray = new Uint8Array(arr);
        //console.log(batesArray);
        webSocket.send(batesArray.buffer);
        return false;
    }

    window.onresize = function(event) {
        var canvasw = $(window).get(0).innerWidth
        var canvash = $(window).get(0).innerHeight
        var renderer = PIXI.autoDetectRenderer(canvasw, canvash, {backgroundColor: 0xffffff});
    };
    var canvasw = $(window).get(0).innerWidth
    var canvash = $(window).get(0).innerHeight
    var renderer = PIXI.autoDetectRenderer(canvasw, canvash, {backgroundColor: 0xffffff});
    document.body.appendChild(renderer.view);

    var canvas = $(renderer.view)[0]
    var stage = new PIXI.Container();
    var context = new PIXI.Graphics();
    var style = {
        font : 'bold italic 20px Arial',
        fill : '#F7EDCA',
        stroke : '#4a1850',
        strokeThickness : 5,
        dropShadow : true,
        dropShadowColor : '#000000',
        dropShadowAngle : Math.PI / 6,
        dropShadowDistance : 6,
        wordWrap : true,
        wordWrapWidth : canvasw
    };

    var richText = new PIXI.Text(location.href,style);
    richText.x = 20;
    richText.y = 20;
//    richText.interactive = true;
//    richText.on('click', onDown);
//
//    function onDown (eventData) {
////        copyText('www.baidu.com');
//        document.execCommand('www.baidu.com'); //执行浏览器复制命令
//        alert("已复制好，可贴粘。");
//    }
    stage.addChild(richText);
    stage.addChild(context);

    renderer.render(stage);


    canvas.onmousedown = function (eventdown) {
        start(eventdown, 'movedown');
        // context.moveTo(eventdown.clientX, eventdown.clientY);
        document.onmousemove = function (eventmove) {
            start(eventmove, 'lineTo');


        };
        document.onmouseup = function (eventup) {
            start(eventup, 'moveup');
//            console.log('onmouseup',eventup.clientX, eventup.clientY);
            document.onmousemove = document.onmouseup = null;

        };
    };

// Set up touch events for mobile, etc
canvas.addEventListener("touchstart", function (e) {
        mousePos = getTouchPos(canvas, e);
  var touch = e.touches[0];
  var mouseEvent = new MouseEvent("mousedown", {
    clientX: touch.clientX,
    clientY: touch.clientY
  });
  canvas.dispatchEvent(mouseEvent);
}, false);
canvas.addEventListener("touchend", function (e) {
  var mouseEvent = new MouseEvent("mouseup", {});
  canvas.dispatchEvent(mouseEvent);
}, false);
canvas.addEventListener("touchmove", function (e) {
  var touch = e.touches[0];
  var mouseEvent = new MouseEvent("mousemove", {
    clientX: touch.clientX,
    clientY: touch.clientY
  });
  canvas.dispatchEvent(mouseEvent);
}, false);

// Get the position of a touch relative to the canvas
function getTouchPos(canvasDom, touchEvent) {
  var rect = canvasDom.getBoundingClientRect();
  return {
    x: touchEvent.touches[0].clientX - rect.left,
    y: touchEvent.touches[0].clientY - rect.top
  };
}

</script>
</body>
</html>