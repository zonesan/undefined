<!DOCTYPE html>
<html lang="UTF8">
<head>
    <title>ChatGo</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
        }

        canvas {
            display: block;
            background-color: #fff;
        }

    </style>
</head>
<body>

<script src="../static/js/jquery-2.1.3.min.js"></script>
<script src="../static/js/pixi.js"></script>
<script>
    Array.prototype.add = function (item) {
        this.push(item);
        if (this.callback) this.callback.call(this, item);
    }
//    alert(window.location.pathname)
    var Drawarr = new Array();
    var lastobj = [];
    var webSocket = new WebSocket('ws://'+location.host + "/ws" + window.location.pathname);
//    var webSocket = new WebSocket('ws://172.18.3.122:1337');
    webSocket.binaryType = 'arraybuffer';

    webSocket.onerror = function (event) {
        onError(event);
    };

    webSocket.onopen = function (event) {
        onOpen(event)
    };

    webSocket.onmessage = function (event) {
        onMessage(event)
    };


    function onMessage(event) {
        //onsole.log(event);

        var bytearray = new Uint8Array(event.data);
        console.log(bytearray.length)
        console.log(bytearray)
    }

    function onOpen(event) {
        console.log(event);
    }

    function onError(event) {

    }

    function start(e, type) {
//        var data = {name: 'my',color: 'red', type: type, clientX: e.clientX - stage_info.left, clientY: e.clientY - stage_info.top};
        if (type == 'lineTo') {
//            var clientX= e.clientX - stage_info.left;
//            var clientY= e.clientY - stage_info.top
            var percentX = 0xFFFF * e.clientX / canvasw
            var x1 = (percentX >> 8) & 0xFF
            var x0 = (percentX >> 0) & 0xFF
            var percentY = 0xFFFF * e.clientY / canvash
            var y1 = (percentY >> 8) & 0xFF
            var y0 = (percentY >> 0) & 0xFF
            var arr = [0, x1, x0, y1, y0]
        } else if (type == 'movedown') {
            var arr = [1]
        } else if (type == 'moveup') {
            var arr = [2]
        }
//        console.log(arr);
        var batesArray = new Uint8Array(arr);
        console.log(batesArray);
        webSocket.send(batesArray.buffer);
        return false;
    }
    var canvasw = $(window).get(0).innerWidth
    var canvash = $(window).get(0).innerHeight
    var renderer = PIXI.autoDetectRenderer(canvasw, canvash, {backgroundColor: 0xffffff});
    document.body.appendChild(renderer.view);

    var canvas = $(renderer.view)[0]
    var stage = new PIXI.Container();
    var context = new PIXI.Graphics();
    var style = {
        font : 'bold italic 20px Arial',
        fill : '#F7EDCA',
        stroke : '#4a1850',
        strokeThickness : 5,
        dropShadow : true,
        dropShadowColor : '#000000',
        dropShadowAngle : Math.PI / 6,
        dropShadowDistance : 6,
        wordWrap : true,
        wordWrapWidth : canvasw
    };

    var richText = new PIXI.Text('姓名:逸杯酒,网址:www.baidu.com',style);
    richText.x = 20;
    richText.y = 20;
//    richText.interactive = true;
//    richText.on('click', onDown);
//
//    function onDown (eventData) {
////        copyText('www.baidu.com');
//        document.execCommand('www.baidu.com'); //执行浏览器复制命令
//        alert("已复制好，可贴粘。");
//    }
    stage.addChild(richText);
    stage.addChild(context);

    renderer.render(stage);

    canvas.onmousedown = function (eventdown) {
        start(eventdown, 'movedown');
        context.moveTo(eventdown.clientX, eventdown.clientY);
        document.onmousemove = function (eventmove) {
            start(eventmove, 'lineTo');
            context.lineStyle(5, 0x1099bb, 1)
            context.lineTo(eventmove.clientX, eventmove.clientY);
            renderer.render(stage);


        };
        document.onmouseup = function (eventup) {
            start(eventup, 'moveup');
//            console.log('onmouseup',eventup.clientX, eventup.clientY);
            document.onmousemove = document.onmouseup = null;

        };
    };

</script>
</body>
</html>